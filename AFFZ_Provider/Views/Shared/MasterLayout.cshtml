@using AFFZ_Provider.Utils
@inject NotificationService NotificationService

@{
	var notifications = await NotificationService.GetNotificationsAsync();
	ViewBag.MerchantId = NotificationService.GetMerchantId();
}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
	<title>Truelysell | Template</title>

	<!-- Favicon -->
	<link rel="shortcut icon" href="/assets/img/favicon.png">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="/assets/css/bootstrap.min.css">

	<!-- Fontawesome CSS -->
	<link rel="stylesheet" href="/assets/plugins/fontawesome/css/fontawesome.min.css">
	<link rel="stylesheet" href="/assets/plugins/fontawesome/css/all.min.css">

	<!-- Fearther CSS -->
	<link rel="stylesheet" href="/assets/css/feather.css">

	<!-- select CSS -->
	<link rel="stylesheet" href="/assets/plugins/select2/css/select2.min.css">

	<!-- Datetimepicker CSS -->
	<link rel="stylesheet" href="/assets/css/bootstrap-datetimepicker.min.css">

	<!-- Main CSS -->
	<link rel="stylesheet" href="/assets/css/style.css">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.9/signalr.min.js"></script>
	<script src="~/js/notification.js"></script>
</head>

<body class="provider-body">


	<div class="main-wrapper">

		@if (ViewContext.RouteData.Values["controller"]?.ToString() != "Login" && ViewContext.RouteData.Values["controller"]?.ToString() != "SignUp")
		{
			
			<!-- Header -->
			<div class="header">
				<div class="header-left">
					<div class="sidebar-logo">
						<a href="index.html">
							<img src="/assets/img/logo.svg" class="img-fluid logo" alt="Logo">
						</a>
						<a href="index.html">
							<img src="/assets/img/logo-small.png" class="img-fluid logo-small" alt="Logo">
						</a>
					</div>
					<div class="siderbar-toggle">
						<label class="switch" id="toggle_btn">
							<input type="checkbox">
							<span class="slider round"></span>
						</label>
					</div>
				</div>
				<a class="mobile_btns" id="mobile_btns" href="javascript:void(0);">
					<i class="fas fa-align-left"></i>
				</a>
				<div class="header-split">
					<div class="page-headers">
						<div class="search-bar">
							
						</div>
					</div>
					<ul class="nav user-menu noti-pop-detail">
						
						<!-- Notifications -->
						<li class="nav-item dropdown logged-item noti-nav noti-wrapper">
							<a href="#" class="dropdown-toggle nav-link notify-link" data-bs-toggle="dropdown">
								<span class="noti-message">@notifications.Where(a=>a.IsRead==false).ToList().Count</span>
								<img src="/assets/img/icons/bell-icon.svg" alt="Bell">
							</a>
							<div class="dropdown-menu notify-blk notifications">
								<div class="topnav-dropdown-header">
									<div>
										<p class="notification-title">Notifications <span>@notifications.Where(a => a.IsRead == false).ToList().Count</span></p>
									</div>
									<a href="javascript:void(0)" class="clear-noti" onclick="markAllAsRead(@ViewBag.MerchantId)">Mark all as read</a>
								</div>
								<div class="noti-content">
									<ul class="notification-list">
										@foreach (var notification in notifications)
										{
											string style = notification.IsRead ? "font-weight:100" : "";
											<li class="notification-message">
												<a href="javascript:void(0)" onclick="markAsReadAndRedirect(@notification.Id, '@notification.RedirectToActionUrl')">

													<div class="media noti-img d-flex">
														<div class="media-body flex-grow-1">
															<p class="noti-details" style="@style">@notification.Message</p>
															<p class="noti-time"><span class="notification-time">@notification.CreatedDate.ToString("g")</span></p>
														</div>
													</div>
												</a>
											</li>
										}
									</ul>
								</div>
								<div class="topnav-dropdown-footer">
									<a href="notification.html">View All Notifications</a>
								</div>
							</div>
						</li>
						<!-- /Notifications -->
						<li class="nav-item  has-arrow dropdown-heads ">
							<a href="#" class="win-maximize">
								<i class="feather-maximize"></i>
							</a>
						</li>

						<!-- User Menu -->
						<li class="nav-item dropdown has-arrow account-item">
							<a href="#" class="dropdown-toggle nav-link" data-bs-toggle="dropdown">
								<div class="user-infos">
									<span class="user-img">
										<img src="/assets/img/profiles/avatar-02.jpg" class="rounded-circle" alt="User Image">
									</span>
									<div class="user-info">
										<h6>John Smith</h6>
										
									</div>
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-end emp">
								<a class="dropdown-item" href="/Profile">
									<i class="feather-user me-2"></i> Profile
								</a>
								<a class="dropdown-item" href="@Url.Action("Logout", "Login")">
									<i class="feather-log-out me-2"></i> Logout
								</a>
							</div>
						</li>
						<!-- /User Menu -->
					</ul>
				</div>

			</div>
			<!-- /Header -->
			<!-- Sidebar -->
			<div class="sidebar" id="sidebar">


				<div class="sidebar-inner slimscroll">
					<div id="sidebar-menu" class="sidebar-menu">
						<ul>
							<li class="active">
								<a href="provider-dashboard.html"><i class="feather-grid"></i> <span>Dashboard</span></a>
							</li>
							<li>
								<a href="provider-services.html"><i class="feather-briefcase"></i> <span>My Services</span></a>
							</li>
							<li>
								<a href="/UserRequestToMerchant/CheckReqest"><i class="feather-calendar"></i> <span>Bookings </span></a>
							</li>
							
							<li>
								<a href="/MerchantResponseToUser/GetUsersWithDocuments"><i class="feather-star"></i> <span>Review User Files</span></a>
							</li>
							<li>
								<a href="/Message/Inbox"><i class="feather-message-circle"></i> <span>Chat</span></a>
							</li>
							<li class="submenu">
								<a href="provider-settings.html"><i class="feather-settings"></i> <span>Settings</span> <span class="menu-arrow"></span></a>
								<ul>
									<li>
										<a href="provider-appointment-settings.html">Appointment Settings</a>
									</li>
									<li>
										<a href="/Profile">Account Settings</a>
									</li>
									<li>
										<a href="provider-social-profile.html">Social Profiles</a>
									</li>
									<li>
										<a href="provider-security-settings.html">Security Setting</a>
									</li>
									<li>
										<a href="provider-plan.html">Plan & Billings</a>
									</li>
									<li>
										<a href="payment-settings.html">Payment Settings</a>
									</li>
									<li>
										<a href="provider-notifcations.html">Notifications</a>
									</li>
									<li>
										<a href="provider-connected-apps.html">Connected Apps</a>
									</li>
									<li>
										<a href="verification.html">Profile Verification</a>
									</li>
									<li>
										<a href="#" data-bs-toggle="modal" data-bs-target="#del-account">Delete Account</a>
									</li>
								</ul>
							</li>
							<li>
								<a class="dropdown-item" href="@Url.Action("Logout", "Login")">
									<i class="feather-log-out me-2"></i> Logout
								</a>
							</li>
						</ul>
						<div class="menu-bottom">
							<div class="menu-user">
								<div class="menu-user-img avatar-online">
									<img src="/assets/img/profiles/avatar-02.jpg" alt="user">
								</div>
								<div class="menu-user-info">
									<h6>John Smith</h6>
									<p>johnsmith@example.com</p>
								</div>
							</div>
							<a href="#" class="select-set"><i class="feather-settings"></i></a>
							<div class="dropdown-menu user-drop" id="dropboxes">
								<div class="menu-user">
									<div class="menu-user-img avatar-online">
										<img src="/assets/img/profiles/avatar-02.jpg" alt="user">
									</div>
									<div class="menu-user-info">
										<h6>John Smith</h6>
										<p>Active</p>
									</div>
								</div>
								<div class="set-user">
									<p>Set as Away</p>
									<div class="status-toggle">
										<input type="checkbox" id="active-user" class="check">
										<label for="active-user" class="checktoggle">checkbox</label>
									</div>
								</div>
								<ul class="set-menu">
									<li>
										<a href="provider-security-settings.html">
											<i class="feather-settings me-2"></i> Settings
										</a>
									</li>
									<li>
										<a href="/Profile">
											<i class="feather-user me-2"></i> Your Account
										</a>
									</li>
									<li>
										<a href="javascript:void(0)">
											<i class="feather-check-circle me-2"></i> Identity Verification
										</a>
									</li>
								</ul>
								<ul class="help-menu">
									<li>
										<a href="#">
											Help Center
										</a>
									</li>
									<li>
										<a href="terms-condition.html">
											Terms of Condition
										</a>
									</li>
									<li>
										<a href="privacy-policy.html">
											Privacy Policy
										</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- /Sidebar -->
		}
		
		@RenderBody()
		<!-- Cursor -->
		<div class="mouse-cursor cursor-outer"></div>
		<div class="mouse-cursor cursor-inner"></div>
		<!-- /Cursor -->

	</div>

	<!-- jQuery -->
	<script src="/assets/js/jquery-3.7.0.min.js"></script>

	<!-- Bootstrap Core JS -->
	<script src="/assets/js/bootstrap.bundle.min.js"></script>

	<!-- Fearther JS -->
	<script src="/assets/js/feather.min.js"></script>

	<!-- select JS -->
	<script src="/assets/plugins/select2/js/select2.min.js"></script>

	<!-- Datetimepicker JS -->
	<script src="/assets/js/moment.min.js"></script>
	<script src="/assets/js/bootstrap-datetimepicker.min.js"></script>

	<!-- Slimscroll JS -->
	<script src="/assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>

	<!-- Custom JS -->
	<script src="/assets/js/script.js"></script>
	@* <script>
		function markAllAsRead() {
			fetch('https://localhost:7047/api/notifications/mark-all-as-read', { method: 'POST' })
				.then(response => {
					if (response.ok) {
						// Optionally, refresh the page or update the UI
					}
				});
		}
		function markAsRead(id,url) {
			fetch('https://localhost:7047/api/Notifications/' + id + '/mark-as-read', { method: 'POST' })
				.then(response => {
					if (response.ok) {
						window.location.href = url;
					}
				});
		}
	</script> *@
	<script>
		function markAsReadAndRedirect(notificationId, redirectUrl) {
			// Mark the notification as read via an API call
			fetch(`https://localhost:7047/api/Notifications/${notificationId}/mark-as-read`, {
				method: 'POST',
			})
				.then(response => {
					if (response.ok) {
						// If successful, redirect to the specified URL
						window.location.href = redirectUrl;
					} else {
						alert('Failed to mark notification as read.');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('An error occurred while processing your request.');
				});
		}

		function markAllAsRead(userOrMerchantId) {
			fetch(`https://localhost:7047/api/Notifications/mark-all-as-read?UserOrMerchantid=${userOrMerchantId}&isUser=false`, {
				method: 'POST',
			})
				.then(response => {
					if (response.ok) {
						// Reload the page or update the notifications count/UI as needed
						location.reload();
					} else {
						alert('Failed to mark all notifications as read.');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('An error occurred while processing your request.');
				});
		}
	</script>
</body>
</html>