@using AFFZ_Customer.Utils
@inject NotificationService NotificationService

@{
    var notifications = await NotificationService.GetNotificationsAsync();
    ViewBag.userId = NotificationService.GetUserId();
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>Truelysell | Template</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/img/favicon.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">

    <!-- Fontawesome CSS -->
    <link rel="stylesheet" href="/assets/plugins/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" href="/assets/plugins/fontawesome/css/all.min.css">

    <!-- Fearther CSS -->
    <link rel="stylesheet" href="/assets/css/feather.css">

    <!-- select CSS -->
    <link rel="stylesheet" href="/assets/plugins/select2/css/select2.min.css">

    <!-- Datetimepicker CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap-datetimepicker.min.css">

    <!-- Main CSS -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.9/signalr.min.js"></script>
    <script src="~/js/notification.js"></script>
</head>

<body>

    <div class="main-wrapper">

        @if (ViewContext.RouteData.Values["controller"]?.ToString() != "Login" && ViewContext.RouteData.Values["controller"]?.ToString() != "SignUp")
        {
            <!-- Header -->
            <header class="header">
                <div class="container">
                    <nav class="navbar navbar-expand-lg header-nav">
                        <div class="navbar-header">
                            <a id="mobile_btn" href="javascript:void(0);">
                                <span class="bar-icon">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </span>
                            </a>
                            <a href="index.html" class="navbar-brand logo">
                                <img src="/assets/img/logo.png" class="img-fluid" alt="Logo">
                            </a>
                            <a href="index.html" class="navbar-brand logo-small">
                                <img src="/assets/img/logo-small.png" class="img-fluid" alt="Logo">
                            </a>
                        </div>
                        <div class="main-menu-wrapper">
                            <div class="menu-header">
                                <a href="index.html" class="menu-logo">
                                    <img src="/assets/img/logo.svg" class="img-fluid" alt="Logo">
                                </a>
                                <a id="menu_close" class="menu-close" href="javascript:void(0);"> <i class="fas fa-times"></i></a>
                            </div>
                            <ul class="main-nav">

                                <li class="login-link">
                                    <a href="choose-signup.html">Register</a>
                                </li>
                                <li class="login-link">
                                    <a href="login.html">Login</a>
                                </li>
                            </ul>
                        </div>
                        <ul class="nav header-navbar-rht noti-pop-detail">
                            <!-- Chat -->
                            <li class="nav-item logged-item msg-nav">
                                <a href="/UserChats" class="nav-link">
                                    <img src="/assets/img/icons/message-icon.svg" alt="Message Icon">
                                </a>
                            </li>
                            <!-- /Chat -->
                            <!-- Notifications -->
                            <li class="nav-item dropdown logged-item noti-nav noti-wrapper">
                                <a href="#" class="dropdown-toggle nav-link notify-link" data-bs-toggle="dropdown">
                                    <span class="noti-message">@notifications.Where(a => a.IsRead == false).ToList().Count</span>
                                    <img src="/assets/img/icons/bell-icon.svg" alt="Bell">
                                </a>
                                <div class="dropdown-menu notify-blk notifications">
                                    <div class="topnav-dropdown-header">
                                        <div>
                                            <p class="notification-title">Notifications <span>@notifications.Where(a => a.IsRead == false).ToList().Count</span></p>
                                        </div>
                                        <a href="javascript:void(0)" class="clear-noti" onclick="markAllAsRead(@ViewBag.userId)">Mark all as read</a>
                                    </div>
                                    <div class="noti-content">
                                        <ul class="notification-list">
                                            @foreach (var notification in notifications)
                                            {
                                                string style = notification.IsRead ? "font-weight:100" : "";
                                                <li class="notification-message">
                                                    <a href="javascript:void(0)" onclick="markAsReadAndRedirect(@notification.Id, '@notification.RedirectToActionUrl')">

                                                        <div class="media noti-img d-flex">
                                                            <div class="media-body flex-grow-1">
                                                                <p class="noti-details" style="@style">@notification.Message</p>
                                                                <p class="noti-time"><span class="notification-time">@notification.CreatedDate.ToString("g")</span></p>
                                                            </div>
                                                        </div>
                                                    </a>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                    <div class="topnav-dropdown-footer">
                                        <a href="notification.html">View All Notifications</a>
                                    </div>
                                </div>
                            </li>
                            <!-- /Notifications -->
                            <!-- User Menu -->
                            <li class="nav-item dropdown has-arrow account-item">
                                <a href="#" class="dropdown-toggle nav-link" data-bs-toggle="dropdown">
                                    <div class="user-infos">
                                        <span class="user-img">
                                            @* <img src="/assets/img/profiles/user.png" class="rounded-circle" alt="User Image"> *@
                                            <img src="@Url.Action("GetImage", "Login", new { userId = "5" })" class="rounded-circle" alt="User Image">
                                        </span>
                                        <div class="user-info">
                                            <h6>John Smith</h6>
                                        </div>
                                    </div>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end emp">
                                    <a class="dropdown-item" href="/Profile">
                                        <i class="feather-user me-2"></i> Profile
                                    </a>
                                    <a class="dropdown-item" href="@Url.Action("Logout", "Login")">
                                        <i class="feather-log-out me-2"></i> Logout
                                    </a>
                                </div>
                            </li>
                            <!-- /User Menu -->
                        </ul>
                    </nav>
                </div>
            </header>
            <!-- /Header -->
        }
        <div class="content">
            <div class="container">
                <div class="row">

                    @if (ViewContext.RouteData.Values["controller"]?.ToString() != "Login" && ViewContext.RouteData.Values["controller"]?.ToString() != "SignUp" && ViewContext.RouteData.Values["controller"]?.ToString() != "Chats")
                    {

                        <!-- Customer Menu -->
                        <div class="col-lg-3 theiaStickySidebar">
                            <div class="settings-widget">
                                <div class="settings-header">
                                    <div class="settings-img">
                                        @* <img src="/assets/img/profiles/user.png" alt="user"> *@
                                        <img src="@Url.Action("GetImage", "Login", new { userId = "5" })" alt="User Image">
                                    </div>
                                    <h6>John Smith</h6>
                                    <p>Member Since Sep 2021</p>
                                </div>
                                @await Component.InvokeAsync("Menu")
                                
                            </div>
                        </div>
                        <!-- /Customer Menu -->
                    }
                    @RenderBody()

                </div>
            </div>
        </div>

        <!-- Cursor -->
        <div class="mouse-cursor cursor-outer"></div>
        <div class="mouse-cursor cursor-inner"></div>
        <!-- /Cursor -->

    </div>

    <!-- jQuery -->
    <script src="/assets/js/jquery-3.7.0.min.js"></script>

    <!-- Bootstrap Core JS -->
    <script src="/assets/js/bootstrap.bundle.min.js"></script>

    <!-- Fearther JS -->
    <script src="/assets/js/feather.min.js"></script>

    <!-- select JS -->
    <script src="/assets/plugins/select2/js/select2.min.js"></script>

    <!-- Datetimepicker JS -->
    <script src="/assets/js/moment.min.js"></script>
    <script src="/assets/js/bootstrap-datetimepicker.min.js"></script>

    <!-- Sticky Sidebar JS -->
    <script src="/assets/plugins/theia-sticky-sidebar/ResizeSensor.js"></script>
    <script src="/assets/plugins/theia-sticky-sidebar/theia-sticky-sidebar.js"></script>

    <!-- Custom JS -->
    <script src="/assets/js/script.js"></script>
    <script>
        function markAsReadAndRedirect(notificationId, redirectUrl) {
            // Mark the notification as read via an API call
            fetch(`https://localhost:7047/api/Notifications/${notificationId}/mark-as-read`, {
                method: 'POST',
            })
                .then(response => {
                    if (response.ok) {
                        // If successful, redirect to the specified URL
                        window.location.href = redirectUrl;
                    } else {
                        alert('Failed to mark notification as read.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing your request.');
                });
        }

        function markAllAsRead(userOrMerchantId) {
            fetch(`https://localhost:7047/api/Notifications/mark-all-as-read?UserOrMerchantid=${userOrMerchantId}&isUser=true`, {
                method: 'POST',
            })
                .then(response => {
                    if (response.ok) {
                        // Reload the page or update the notifications count/UI as needed
                        location.reload();
                    } else {
                        alert('Failed to mark all notifications as read.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing your request.');
                });
        }
    </script>
</body>
</html>